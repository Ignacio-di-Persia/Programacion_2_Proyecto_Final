<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lista de Socios</title>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea, #764ba2);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: auto;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        h1 { text-align: center; margin-bottom: 25px; }
        .search-section { display: flex; gap: 10px; margin-bottom: 20px; }
        .search-input, .search-select {
            padding: 10px; border-radius: 8px; border: 2px solid #ddd;
        }
        .btn { padding: 10px 15px; border-radius: 8px; cursor: pointer; border: none; font-weight: bold; }
        .btn-home { background: #6c757d; color: white; margin-bottom: 20px; text-decoration:none; display:inline-block; }
        .btn-edit { background: #ffc107; }
        .btn-delete { background: #dc3545; color:white; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px; border-bottom: 1px solid #ddd; }
        th { background: #667eea; color: white; }
        tr:hover { background: #f2f2f2; }
        .actions { display: flex; gap: 5px; }
        .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; }
        .modal-content { background:white; padding:25px; border-radius:10px; width:400px; }
    </style>
</head>

<body>
<div class="container">

    <a th:href="@{/}" class="btn btn-home">üè† Volver al Inicio</a>

    <h1>üìã Lista de Socios</h1>

    <div class="search-section">
        <input type="text" id="searchInput" class="search-input" placeholder="Buscar por apellido o DNI...">
    </div>

    <table>
        <thead>
            <tr>
                <th>DNI</th>
                <th>Nombres</th>
                <th>Apellidos</th>
                <th>Fecha de Nacimiento</th>
                <th>Correo</th>
                <th>Veh√≠culo</th>
                <th>Garage</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody id="sociosBody"></tbody>
    </table>
</div>

<!-- MODAL EDITAR -->
<div id="editModal" class="modal">
    <div class="modal-content">
        <h3>‚úèÔ∏è Editar Socio</h3>
        <form id="editForm">
            <label>DNI:</label>
            <input type="number" id="editDni" readonly><br><br>

            <label>Nombres:</label>
            <input type="text" id="editNombres" required><br><br>

            <label>Apellidos:</label>
            <input type="text" id="editApellidos" required><br><br>

            <label>Fecha de Nacimiento:</label>
            <input type="date" id="editfechaNacimiento" required><br><br>

            <label>Correo:</label>
            <input type="email" id="editCorreo" required><br><br>

            <label>Veh√≠culo:</label>
            <input type="text" id="editVehiculo"><br><br>

            <label>Garage:</label>
            <select id="editGarage" required></select><br><br>

            <button type="button" onclick="closeEditModal()" class="btn btn-home">Cancelar</button>
            <button type="submit" class="btn btn-edit">Guardar</button>
        </form>
    </div>
</div>

<!-- MODAL ELIMINAR -->
<div id="deleteModal" class="modal">
    <div class="modal-content" style="text-align:center;">
        <h3>‚ùó Confirmar Eliminaci√≥n</h3>
        <p>¬øEst√°s seguro que deseas eliminar este socio?</p>
        <p><strong id="deleteNombre"></strong></p>

        <br>
        <button class="btn btn-home" onclick="closeDeleteModal()">Cancelar</button>
        <button id="confirmDeleteBtn" class="btn btn-delete">Eliminar</button>
    </div>
</div>

<script>
const API_URL = '/guarderia-central/api/socios';
const API_GARAGE = '/guarderia-central/api/garage';
let GarageActuales = [];   

async function cargarGarageEnSelect() {
    const res = await fetch(API_GARAGE);
    const garage = await res.json();
    const select = document.getElementById("editGarage");

    select.innerHTML = garage.map(g => 
        `<option value="${g.codigo}">${g.codigo} - ${g.descripcion}</option>`
    ).join('');
}

async function cargarSocios() {
    const res = await fetch(API_URL);
    const socios = await res.json();
    mostrarSocios(socios);
}

function mostrarSocios(socios) {
    const tbody = document.getElementById('sociosBody');
    tbody.innerHTML = socios.map(s => `
        <tr>
            <td>${s.dni}</td>
            <td>${s.nombres}</td>
            <td>${s.apellidos}</td>
            <td>${s.fechaNacimiento}</td>
            <td>${s.correo}</td>
            <td>${s.vehiculo}</td>
            <td>${s.garage}</td>
            <td class="actions">
                <button class="btn btn-edit" onclick="editarSocio(${s.dni})">Editar</button>
                <button class="btn btn-delete" onclick="eliminarSocio(${s.dni})">Eliminar</button>
            </td>
        </tr>
    `).join('');
}

async function editarSocio(dni) {
    const res = await fetch(`${API_URL}/${dni}`);
    const s = await res.json();

    editDni.value = s.dni;
    editNombres.value = s.nombres;
    editApellidos.value = s.apellidos;
    editfechaNacimiento.value = s.fechaNacimiento;
    editCorreo.value = s.correo;
    editVehiculo.value = s.vehiculo;
    editGarage.value = s.garage;

    editModal.style.display = 'flex';
}

document.getElementById('editForm').addEventListener('submit', async e => {
    e.preventDefault();
    const s = {
        dni: parseInt(editDni.value),
        nombres: editNombres.value,
        apellidos: editApellidos.value,
        fechaNacimiento: editfechaNacimiento.value,
        correo: editCorreo.value,
        vehiculo: editVehiculo.value,
        garage: editGarage.value
    };
    await fetch(`${API_URL}/${s.dni}`, { method:'PUT', headers:{'Content-Type':'application/json'}, body:JSON.stringify(s)});
    closeEditModal();
    cargarSocios();
});

function closeEditModal() { editModal.style.display='none'; }

cargarSocios();

let dniAEliminar = null;

async function eliminarSocio(dni) {
    dniAEliminar = dni;

    // obtenemos data para mostrar nombre en el modal
    const res = await fetch(`${API_URL}/${dni}`);
    const s = await res.json();
    document.getElementById("deleteNombre").textContent = `${s.nombres} ${s.apellidos} (DNI: ${s.dni})`;

    deleteModal.style.display = 'flex';
}

document.getElementById("confirmDeleteBtn").addEventListener("click", async () => {
    await fetch(`${API_URL}/${dniAEliminar}`, { method: 'DELETE' });
    closeDeleteModal();
    cargarSocios();
});

function closeDeleteModal() {
    deleteModal.style.display = 'none';
}

</script>
</body>
</html>


