<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Lista de Empleados</title>
<style>
* { margin:0; padding:0; box-sizing:border-box; }
body { font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg,#667eea,#764ba2); min-height:100vh; padding:20px; }
.container { max-width:1200px; margin:auto; background:white; border-radius:15px; padding:30px; box-shadow:0 10px 40px rgba(0,0,0,0.2); }
h1 { text-align:center; margin-bottom:25px; }
.btn { padding:10px 15px; border-radius:8px; border:none; font-weight:600; cursor:pointer; text-decoration:none; display:inline-block; transition:0.3s; }
.btn-home { background:#6c757d; color:white; margin-bottom:20px; }
.btn-home:hover { background:#5a6268; }
.btn-add { background:#28a745; color:white; margin-bottom:15px; }
.btn-add:hover { background:#218838; }
.btn-edit { background:#ffc107; }
.btn-edit:hover { background:#e0a800; }
.btn-delete { background:#dc3545; color:white; }
.btn-delete:hover { background:#c82333; }
table { width:100%; border-collapse:collapse; margin-top:10px; }
th, td { padding:12px; border-bottom:1px solid #ddd; text-align:center; }
th { background:#667eea; color:white; }
tr:hover { background:#f2f2f2; }
.actions { display:flex; gap:5px; justify-content:center; }
.modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; }
.modal-content { background:white; padding:25px; border-radius:10px; width:450px; box-shadow:0 10px 30px rgba(0,0,0,0.2); text-align:center; max-height:90vh; overflow-y:auto; }
</style>
</head>
<body>
<div class="container">
    <a th:href="@{/}" class="btn btn-home">üè† Volver al Inicio</a>
    <h1>üë∑ Lista de Empleados</h1>
    <a th:href="@{/empleados/agregar-empleado}" class="btn btn-add">‚ûï Agregar Empleado</a>

    <table>
        <thead>
            <tr>
                <th>DNI</th>
                <th>Nombres</th>
                <th>Apellidos</th>
                <th>Direcci√≥n</th>
                <th>Tel√©fono</th>
                <th>Especialidad</th>
                <th>Zona(s) Asignada(s)</th>
                <th>Veh√≠culos asignados</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody id="empleadosBody"></tbody>
    </table>
</div>

<!-- MODAL EDITAR EMPLEADO -->
<div id="editModal" class="modal">
    <div class="modal-content">
        <h3>‚úèÔ∏è Editar Empleado</h3>
        <form id="editForm">
            <label>C√≥digo (ID):</label>
            <input type="number" id="editCodigo" readonly><br><br>

            <label>DNI:</label>
            <input type="number" id="editDni" required><br><br>

            <label>Nombres:</label>
            <input type="text" id="editNombres" required><br><br>

            <label>Apellidos:</label>
            <input type="text" id="editApellidos" required><br><br>

            <label>Direcci√≥n:</label>
            <input type="text" id="editDireccion"><br><br>

            <label>Tel√©fono:</label>
            <input type="text" id="editTelefono"><br><br>

            <label>Especialidad:</label>
            <input type="text" id="editEspecialidad"><br><br>

            <label>Zona asignada:</label>
            <select id="editZona" required></select><br><br>

            <label>Cantidad de veh√≠culos asignados:</label>
            <input type="number" id="editVehiculos" min="0" value="0"><br><br>

            <button type="button" onclick="closeEditModal()" class="btn btn-home">Cancelar</button>
            <button type="submit" class="btn btn-edit">Guardar</button>
        </form>
    </div>
</div>

<!-- MODAL ELIMINAR -->
<div id="deleteModal" class="modal">
    <div class="modal-content">
        <h3>‚ùó Confirmar Eliminaci√≥n</h3>
        <p>¬øSeguro que deseas eliminar este empleado?</p>
        <p><strong id="deleteNombre"></strong></p>
        <br>
        <button class="btn btn-home" onclick="closeDeleteModal()">Cancelar</button>
        <button id="confirmDeleteBtn" class="btn btn-delete">Eliminar</button>
    </div>
</div>

<script>
const API_URL = '/guarderia-central/api/empleados';
const API_ZONAS = '/guarderia-central/api/zonas';
let codigoAEliminar = null;
let zonasActuales = []; 

async function cargarZonasEnSelect() {
    const res = await fetch(API_ZONAS);
    const zonas = await res.json();
    const select = document.getElementById("editZona");

    select.innerHTML = zonas.map(z => 
        `<option value="${z.codigo}">${z.codigo} - ${z.descripcion}</option>`
    ).join('');
}



// Abrir modal editar
async function openEditModal(empleado) {

    await cargarZonasEnSelect(); // <<< NUEVO

    document.getElementById("editCodigo").value = empleado.codigo;
    document.getElementById("editDni").value = empleado.dni;
    document.getElementById("editNombres").value = empleado.nombres;
    document.getElementById("editApellidos").value = empleado.apellidos;
    document.getElementById("editDireccion").value = empleado.direccion;
    document.getElementById("editTelefono").value = empleado.telefono;
    document.getElementById("editEspecialidad").value = empleado.especialidad;

    zonasActuales = empleado.zonasAsignadas || [];

    // Se muestra la zona asignada
    if (zonasActuales.length > 0) {
        document.getElementById("editZona").value = zonasActuales[0].zonaCodigo;
        document.getElementById("editVehiculos").value = zonasActuales[0].vehiculosAsignados;
    }

    document.getElementById("editModal").style.display = "block";
}

function closeEditModal() {
    document.getElementById("editModal").style.display = "none";
}

// Cargar empleados
async function cargarEmpleados(){
    const res = await fetch(API_URL);
    const empleados = await res.json();
    const tbody = document.getElementById('empleadosBody');

    tbody.innerHTML = empleados.map(e => {
        const zonas = e.zonasAsignadas?.map(z => z.zonaCodigo).join(", ") || '';
        const vehiculos = e.zonasAsignadas?.reduce((sum, z) => sum + (z.vehiculosAsignados||0), 0) || 0;
        return `<tr>
            <td>${e.dni}</td>
            <td>${e.nombres}</td>
            <td>${e.apellidos}</td>
            <td>${e.direccion || ''}</td>
            <td>${e.telefono || ''}</td>
            <td>${e.especialidad || ''}</td>
            <td>${zonas}</td>
            <td>${vehiculos}</td>
            <td class="actions">
                <button class="btn btn-edit" onclick='openEditModal(${JSON.stringify(e)})'>‚úèÔ∏è Editar</button>
                <button class="btn btn-delete" onclick="eliminarEmpleado(${e.codigo})">üóëÔ∏è Eliminar</button>
            </td>
        </tr>`;
    }).join('');
}

// Modal eliminar
async function eliminarEmpleado(codigo){
    codigoAEliminar = codigo;
    const res = await fetch(`${API_URL}/${codigo}`);
    const e = await res.json();
    document.getElementById("deleteNombre").textContent = `${e.nombres} ${e.apellidos} (DNI: ${e.dni})`;
    document.getElementById("deleteModal").style.display='flex';
}

document.getElementById("confirmDeleteBtn").addEventListener("click", async ()=>{
    await fetch(`${API_URL}/${codigoAEliminar}`,{method:'DELETE'});
    closeDeleteModal();
    cargarEmpleados();
});

function closeDeleteModal(){ document.getElementById("deleteModal").style.display='none'; }

// Guardar edici√≥n
document.getElementById("editForm").addEventListener("submit", async e=>{
    e.preventDefault();

    const zonaSeleccionada = document.getElementById("editZona").value;
    const vehiculos = parseInt(document.getElementById("editVehiculos").value);

    const empleado = {
        codigo: parseInt(document.getElementById("editCodigo").value),
        dni: parseInt(document.getElementById("editDni").value),
        nombres: document.getElementById("editNombres").value.trim(),
        apellidos: document.getElementById("editApellidos").value.trim(),
        direccion: document.getElementById("editDireccion").value.trim()||null,
        telefono: document.getElementById("editTelefono").value.trim()||null,
        especialidad: document.getElementById("editEspecialidad").value.trim()||null,

        // AHORA S√ç SE MODIFICA LA ZONA Y CANT VEHICULOS
        zonasAsignadas: [
            { zonaCodigo: zonaSeleccionada, vehiculosAsignados: vehiculos }
        ]
    };

    await fetch(`${API_URL}/${empleado.codigo}`, {
        method:'PUT',
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify(empleado)
    });

    closeEditModal();
    cargarEmpleados();
});

cargarEmpleados();
</script>
</body>
</html>